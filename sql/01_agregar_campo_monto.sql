/*
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  SCRIPT: Agregar campo Monto a tabla Pago                                     โ
โ  Propรณsito: Registrar el monto pagado por cada cita                          โ
โ  FASE 1: Sistema de Gestiรณn de Hospital                                      โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
*/

USE GestorHospitalDB;
GO

PRINT 'โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ';
PRINT '๐ง INICIANDO MODIFICACIรN DE TABLA PAGO';
PRINT 'โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ';
GO

-- โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
-- PASO 1: Verificar estructura actual
-- โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
PRINT '';
PRINT '๐ Verificando estructura actual de tabla Pago...';
SELECT 
    COLUMN_NAME,
    DATA_TYPE,
    IS_NULLABLE
FROM INFORMATION_SCHEMA.COLUMNS
WHERE TABLE_NAME = 'Pago'
ORDER BY ORDINAL_POSITION;
GO

-- โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
-- PASO 2: Agregar campo Monto (NULL temporalmente)
-- โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
PRINT '';
PRINT 'โ Agregando campo Monto a tabla Pago...';

-- Verificar si el campo ya existe
IF NOT EXISTS (
    SELECT * FROM INFORMATION_SCHEMA.COLUMNS 
    WHERE TABLE_NAME = 'Pago' AND COLUMN_NAME = 'Monto'
)
BEGIN
    ALTER TABLE Pago
    ADD Monto DECIMAL(10,2) NULL;
    PRINT 'โ Campo Monto agregado exitosamente';
END
ELSE
BEGIN
    PRINT 'โ๏ธ  Campo Monto ya existe, saltando...';
END
GO

-- โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
-- PASO 3: Actualizar pagos existentes con el monto correcto
-- โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
PRINT '';
PRINT '๐ฐ Actualizando pagos existentes con montos correctos...';

UPDATE P
SET P.Monto = E.Precio
FROM Pago P
INNER JOIN Citas C ON P.Id_Cita = C.Id_Cita
INNER JOIN Doctores D ON C.Id_Doc = D.Id_Doctor
INNER JOIN Especialidades E ON D.Id_Especialidad = E.Id_Especialidad
WHERE P.Monto IS NULL;

PRINT 'โ Pagos existentes actualizados: ' + CAST(@@ROWCOUNT AS VARCHAR(10)) + ' registros';
GO

-- โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
-- PASO 4: Hacer el campo obligatorio
-- โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
PRINT '';
PRINT '๐ Haciendo el campo Monto obligatorio...';

ALTER TABLE Pago
ALTER COLUMN Monto DECIMAL(10,2) NOT NULL;

PRINT 'โ Campo Monto ahora es obligatorio';
GO

-- โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
-- PASO 5: Verificar cambios
-- โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
PRINT '';
PRINT '๐ Nueva estructura de tabla Pago:';
SELECT 
    COLUMN_NAME,
    DATA_TYPE,
    IS_NULLABLE,
    CHARACTER_MAXIMUM_LENGTH
FROM INFORMATION_SCHEMA.COLUMNS
WHERE TABLE_NAME = 'Pago'
ORDER BY ORDINAL_POSITION;
GO

-- โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
-- PASO 6: Verificar datos de ejemplo
-- โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
PRINT '';
PRINT '๐ Datos de ejemplo (Top 5):';
SELECT TOP 5
    P.Id_Pago,
    P.Id_Cita,
    P.Monto,
    P.Metodo_Pago,
    P.Fecha,
    E.Nombre AS Especialidad
FROM Pago P
INNER JOIN Citas C ON P.Id_Cita = C.Id_Cita
INNER JOIN Doctores D ON C.Id_Doc = D.Id_Doctor
INNER JOIN Especialidades E ON D.Id_Especialidad = E.Id_Especialidad
ORDER BY P.Id_Pago DESC;
GO

PRINT '';
PRINT 'โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ';
PRINT 'โ MODIFICACIรN COMPLETADA EXITOSAMENTE';
PRINT 'โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ';
GO
